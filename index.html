<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questionario</title>
    <link rel="stylesheet" href="index.css">
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const userId = getCookie('userId') || generateUserId();
            const userStatus = await checkUserSubmission(userId);

            if (userStatus.hasSubmitted) {
                window.location.href = 'already-answered.html';
            }

            const form = document.getElementById('quizForm');
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (userStatus.hasSubmitted) {
                    window.location.href = 'thankyou.html';
                } else {
                    const selectedAnswer = document.querySelector('input[name="answer"]:checked');
                    if (selectedAnswer) {
                        const answerValue = selectedAnswer.value;

                        // Invia la risposta al backend
                        await fetch(`https://api-7524dbiyoq-uc.a.run.app/answers`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ answer: answerValue })
                        });

                        // Aggiorna lo stato dell'utente nel backend
                        await fetch(`https://api-7524dbiyoq-uc.a.run.app/user/${userId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ hasSubmitted: true })
                        });

                        window.location.href = 'thankyou.html';
                    } else {
                        alert("Seleziona una risposta prima di inviare.");
                    }
                }
            });

            window.addEventListener('popstate', () => {
                if (location.pathname.endsWith('index.html')) {
                    location.reload();
                }
            });
        });

        async function checkUserSubmission(userId) {
            const response = await fetch(`https://api-7524dbiyoq-uc.a.run.app/user/${userId}`);
            return await response.json();
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        function setCookie(name, value, days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = `expires=${date.toUTCString()}`;
            document.cookie = `${name}=${value};${expires};path=/`;
        }

        function generateUserId() {
            const userId = `user-${Math.random().toString(36).substr(2, 9)}`;
            setCookie('userId', userId, 365);
            return userId;
        }
    </script>
</head>
<body>
    <div class="container">
        <form id="quizForm">
            <h1>Qual Ã¨ la tua risposta preferita?</h1>
            <label><input type="radio" name="answer" value="A"> Risposta A</label><br>
            <label><input type="radio" name="answer" value="B"> Risposta B</label><br>
            <label><input type="radio" name="answer" value="C"> Risposta C</label><br>
            <label><input type="radio" name="answer" value="D"> Risposta D</label><br>
            <button type="submit">Invia</button>
        </form>
    </div>
    <script src="script.js"></script>
</body>
</html>
